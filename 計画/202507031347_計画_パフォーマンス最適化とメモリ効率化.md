# パフォーマンス最適化とメモリ効率化計画

作成日: 2025-07-03 13:47

## 概要
ast2graphプロジェクトの性能最適化とメモリ効率化を実施する。現在の基本実装は機能的には完成しているが、大規模プロジェクトでの処理速度とメモリ使用量の最適化が必要。

## 現状分析

### パフォーマンス目標（要件定義より）
- 300ファイル、総ASTノード数75,000-600,000を10分以内で処理
- メモリ使用量500MB以下
- 100%決定的処理

### 現在の実装状況
- バッチ処理：基本実装完了（BatchProcessor）
- 並列処理：ProcessPoolExecutor対応済み
- ストリーミング：parse_files_stream実装済み
- メモリ管理：MemoryManager実装済み（psutil依存）

### 性能ボトルネック候補
1. AST走査の重複（graph_builderとdependency_extractorで個別に走査）
2. グラフ構造の全体保持（大規模プロジェクトでメモリ圧迫）
3. 決定的ID生成のハッシュ計算コスト
4. JSON シリアライズ時のメモリ使用量

## 実装計画

### Phase 1: プロファイリングと測定（2日）

#### 1.1 パフォーマンス測定基盤の構築
- [ ] ベンチマークテストスイートの作成
  - 小規模（10ファイル）、中規模（100ファイル）、大規模（300ファイル）
  - 各種ASTパターンのテストケース
- [ ] プロファイリングツールの統合
  - cProfile/line_profiler設定
  - memory_profiler設定
  - 測定結果の自動レポート生成

#### 1.2 現状のベースライン測定
- [ ] 処理時間の測定（ファイル数、ノード数別）
- [ ] メモリ使用量の測定（ピーク、平均）
- [ ] ボトルネック箇所の特定

### Phase 2: AST走査最適化（3日）

#### 2.1 統合AST走査の実装
- [ ] graph_builderとdependency_extractorを統合したビジター
- [ ] 1回のAST走査で全情報を収集
- [ ] 走査結果のキャッシング機構

#### 2.2 選択的ノード処理
- [ ] 不要なASTノードのスキップロジック
- [ ] 深さ制限オプションの追加
- [ ] ノードタイプフィルタリング

### Phase 3: メモリ効率化（3日）

#### 3.1 グラフ構造の最適化
- [ ] ノード/エッジの遅延読み込み
- [ ] 弱参照（weakref）の活用
- [ ] 不要な中間データの早期解放

#### 3.2 ストリーミング処理の強化
- [ ] ファイル単位での部分グラフ生成
- [ ] 増分的なグラフマージ
- [ ] メモリマップファイルの活用検討

#### 3.3 データ構造の最適化
- [ ] ASTGraphNodeのメモリフットプリント削減
- [ ] エッジの圧縮表現
- [ ] 文字列のインターン化

### Phase 4: 並列処理最適化（2日）

#### 4.1 並列化戦略の改善
- [ ] 動的なワーカー数調整
- [ ] タスク粒度の最適化
- [ ] 共有メモリの活用（multiprocessing.shared_memory）

#### 4.2 I/O最適化
- [ ] 非同期ファイル読み込み
- [ ] バッファリング戦略の改善
- [ ] ファイルシステムキャッシュの活用

### Phase 5: キャッシング機構（2日）

#### 5.1 ASTキャッシュ
- [ ] 解析済みASTのディスクキャッシュ
- [ ] ファイルハッシュベースの無効化
- [ ] LRUキャッシュの実装

#### 5.2 グラフキャッシュ
- [ ] 部分グラフのキャッシュ
- [ ] 依存関係情報のキャッシュ
- [ ] キャッシュの永続化オプション

## 検証計画

### パフォーマンステスト
- [ ] 実際のOSSプロジェクトでのベンチマーク
  - Django、Flask、Requests等
- [ ] 処理時間の改善率測定
- [ ] メモリ使用量の削減率測定

### 回帰テスト
- [ ] 既存の全テストが通過することを確認
- [ ] 決定性の保証が維持されていることを確認
- [ ] 出力の正確性検証

## 成功基準

1. **処理速度**
   - 300ファイルを5分以内で処理（現状の目標10分から50%改善）
   - 中規模プロジェクト（100ファイル）を1分以内で処理

2. **メモリ効率**
   - ピークメモリ使用量300MB以下（現状の目標500MBから40%改善）
   - ストリーミング処理時の固定メモリフットプリント

3. **品質維持**
   - 全テストの成功（回帰なし）
   - 100%決定的処理の維持
   - APIの後方互換性維持

## リスクと対策

1. **最適化による複雑性増加**
   - 対策：段階的な実装とテスト
   - 各最適化のon/offオプション提供

2. **決定性の喪失リスク**
   - 対策：決定性テストの強化
   - ハッシュベースの出力検証

3. **並列処理のデバッグ困難性**
   - 対策：詳細なログ出力
   - 並列処理の無効化オプション

## 実装優先順位

1. プロファイリング基盤構築（必須）
2. AST走査統合（高インパクト）
3. メモリ効率化（中インパクト）
4. キャッシング機構（中インパクト）
5. 並列処理最適化（低インパクト）

## 次のステップ

1. ベンチマークテストスイートの作成から開始
2. 現状のパフォーマンスベースライン測定
3. 最もインパクトの大きい最適化から順次実装