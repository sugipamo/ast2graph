# グラフ構築機能実装計画 ✅ 完了

## 作成日時
2025-07-03 01:16

## 完了日時
2025-07-03 01:30

## 概要
PythonのASTをグラフ構造に変換する機能（graph_builder.py）の実装計画。
既に実装済みのparser.pyで解析したASTを、models.pyとgraph_structure.pyで定義されたデータ構造に変換する。

## 実装目標
1. ASTノードをグラフノードに変換
2. ノード間の関係性をエッジとして表現
3. 依存関係の基本的な追跡
4. 決定的な処理（同一入力で同一出力）の保証

## 実装内容

### 1. GraphBuilder クラス設計
```python
class GraphBuilder:
    def __init__(self, ast_tree: ast.AST, source_info: SourceInfo):
        """
        グラフビルダーの初期化
        
        Args:
            ast_tree: 解析済みのAST
            source_info: ソースコード情報
        """
        self.ast_tree = ast_tree
        self.source_info = source_info
        self.graph = GraphStructure()
        self._node_counter = 0
        self._node_mapping = {}  # AST node -> GraphNode IDのマッピング
```

### 2. 主要なメソッド

#### 2.1 build_graph() - メインエントリーポイント
```python
def build_graph(self) -> GraphStructure:
    """ASTからグラフを構築"""
    self._visit(self.ast_tree)
    return self.graph
```

#### 2.2 _visit() - ノード訪問ロジック
```python
def _visit(self, node: ast.AST, parent_id: Optional[str] = None) -> str:
    """
    ASTノードを訪問してグラフノードに変換
    
    Returns:
        作成されたグラフノードのID
    """
```

#### 2.3 _create_node() - グラフノード作成
```python
def _create_node(self, ast_node: ast.AST) -> ASTGraphNode:
    """ASTノードからグラフノードを作成"""
```

#### 2.4 _create_edge() - エッジ作成
```python
def _create_edge(self, source_id: str, target_id: str, edge_type: EdgeType):
    """ノード間のエッジを作成"""
```

### 3. サポートするASTノードタイプ

#### Phase 1（初期実装）
- **Module**: モジュール全体
- **FunctionDef**: 関数定義
- **ClassDef**: クラス定義
- **Import/ImportFrom**: インポート文
- **Assign**: 代入文
- **Name**: 変数参照
- **Call**: 関数呼び出し
- **Attribute**: 属性アクセス

#### Phase 2（次の実装）
- **If/While/For**: 制御構造
- **Try/Except**: 例外処理
- **With**: コンテキストマネージャ
- **Comprehensions**: 内包表記

### 4. エッジタイプの判定ロジック

```python
def _determine_edge_type(self, parent_node: ast.AST, child_node: ast.AST) -> EdgeType:
    """親子ノード間の関係からエッジタイプを決定"""
    # 例:
    # - FunctionDef -> body内のノード: CONTAINS
    # - Import -> alias: IMPORTS
    # - Call -> func: CALLS
    # - Name（変数参照）: REFERENCES
```

### 5. 決定的処理の保証

1. **ノードIDの生成**
   - カウンターベースの連番ID（node_0, node_1, ...）
   - 深さ優先探索で一定順序を保証

2. **辞書の順序保持**
   - Python 3.7+の挿入順序保持を活用
   - 明示的なソートは不要

3. **エッジの順序**
   - ソースIDとターゲットIDでソート済みリストを維持

### 6. エラーハンドリング

```python
try:
    graph_node = self._create_node(ast_node)
except Exception as e:
    raise GraphBuildError(
        f"Failed to create graph node for {type(ast_node).__name__}",
        source_info=self.source_info,
        line_number=getattr(ast_node, 'lineno', None)
    ) from e
```

### 7. テスト計画

1. **単体テスト**
   - 各ASTノードタイプの変換テスト
   - エッジタイプ判定のテスト
   - エラーケースのテスト

2. **統合テスト**
   - 実際のPythonコードでのエンドツーエンドテスト
   - 決定的処理の検証（同一入力で同一出力）

3. **パフォーマンステスト**
   - 大規模ファイルでの処理速度測定
   - メモリ使用量の測定

### 8. 実装ステップ

1. **Step 1**: GraphBuilderクラスの基本構造実装
2. **Step 2**: 基本的なASTノードタイプのサポート（Module, FunctionDef, ClassDef）
3. **Step 3**: ノード訪問ロジックの実装
4. **Step 4**: エッジ作成とタイプ判定ロジック
5. **Step 5**: インポート文と依存関係の処理
6. **Step 6**: テストの実装と実行
7. **Step 7**: ドキュメントとコメントの追加

### 9. 期待される成果

- graph_builder.pyの完全な実装
- 主要なPython構文のサポート
- 100%の決定的処理
- 包括的なテストカバレッジ
- 次フェーズ（依存関係抽出）への準備完了

### 10. リスクと対策

1. **複雑なAST構造への対応**
   - 段階的な実装でリスクを軽減
   - 未サポートノードは警告付きでスキップ

2. **パフォーマンス問題**
   - プロファイリングによる早期発見
   - 必要に応じて最適化を実施

3. **エッジケース**
   - 包括的なテストで早期発見
   - エラーハンドリングの充実

## 実装結果

### 完了した内容
1. ✅ GraphBuilderクラスの完全な実装
2. ✅ 主要なASTノードタイプのサポート
   - Module, FunctionDef, AsyncFunctionDef, ClassDef
   - Import, ImportFrom
   - Assign, AugAssign, AnnAssign
   - Call, Name, Attribute
   - If, For, While, Return
3. ✅ エッジタイプの適切な判定
   - CHILD: 構造的な親子関係
   - DEFINES: 変数定義、関数定義など
   - REFERENCES: 変数参照
   - CALLS: 関数呼び出し
4. ✅ 決定的なUUID生成による再現性の保証
5. ✅ 包括的な単体テスト（17個のテストケース全て合格）

### 実装のハイライト
- TDD形式での開発により、高品質なコードを実現
- エラーハンドリングの適切な実装
- 拡張性の高い設計（新しいノードタイプの追加が容易）

### 次のステップ
- エクスポート機能の実装
- より高度な依存関係抽出機能の追加
- パフォーマンス最適化