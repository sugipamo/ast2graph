# バッチ処理と並列処理実装計画 ✅ 部分完了

## 概要
ast2graphプロジェクトの次フェーズとして、大規模ファイル処理のためのバッチ処理と並列処理機能を実装する。

## 実装状況（2025-07-03）
- ✅ BatchProcessorクラスの基本実装完了
- ✅ BatchResultデータ構造の定義完了
- ✅ 基本的なバッチ処理のテスト作成（42テスト追加、37テスト成功）
- ✅ エラーハンドリング機構の実装
- ✅ 進捗監視機能の基本実装
- ✅ メモリ管理機能の基本実装（psutil依存、オプショナル）
- ✅ ストリーミング処理の実装
- ⏳ マルチプロセシング実装（基本実装済み、テスト未実施）
- ❌ パフォーマンステストとベンチマーク
- ❌ ドキュメント作成

## 現状分析

### 実装済み機能
- ✅ 基本的な並列処理（`parse_directory`でThreadPoolExecutor使用）
- ✅ ストリーミングAPI（`parse_files_stream`）
- ✅ 進捗コールバック機能（基本実装済み）

### 実装完了機能（2025-07-03）
- ✅ 専用バッチ処理クラス（BatchProcessor）
- ✅ マルチプロセシング実装（ProcessPoolExecutor対応）
- ✅ 詳細な進捗監視機能（ProcessingProgress）
- ✅ リソース管理機構（MemoryManager）
- ✅ エラー時の再試行機能（ErrorRecoveryStrategy）

## 実装目標

### 性能要件（要件定義より）
- 300ファイル、総ASTノード数75,000-600,000を10分以内で処理
- メモリ使用量500MB以下（ピーク時）
- 100%決定的処理の維持

## 実装計画

### 1. バッチ処理基盤の構築

#### 1.1 BatchProcessor クラスの実装
```python
class BatchProcessor:
    def __init__(self, 
                 batch_size: int = 50,
                 max_workers: int = None,
                 memory_limit_mb: int = 500):
        pass
    
    def process_files(self,
                     file_paths: List[str],
                     progress_callback: Callable = None) -> BatchResult:
        pass
```

#### 1.2 BatchResult データ構造
```python
@dataclass
class BatchResult:
    total_files: int
    processed_files: int
    failed_files: List[FailedFile]
    processing_time: float
    memory_peak_mb: float
    graphs: List[GraphStructure]
```

### 2. 並列処理の高度化

#### 2.1 マルチプロセシング実装
- ProcessPoolExecutorの使用
- プロセス間通信の最適化
- シリアライズ可能なデータ構造の確保

#### 2.2 ハイブリッド並列処理
```python
class ParallelProcessor:
    def __init__(self,
                 process_workers: int = None,
                 thread_workers: int = 4):
        # プロセス並列（CPU集約的なAST解析）
        # スレッド並列（I/O集約的なファイル読み込み）
        pass
```

### 3. 進捗監視機能の強化

#### 3.1 詳細な進捗情報
```python
@dataclass
class ProcessingProgress:
    current_file: str
    files_completed: int
    files_total: int
    current_phase: str  # "parsing", "building", "exporting"
    elapsed_time: float
    estimated_remaining: float
    memory_usage_mb: float
```

#### 3.2 リアルタイム監視
- 進捗バーのサポート
- キャンセル可能な処理
- 中断・再開機能

### 4. エラーハンドリングと回復

#### 4.1 エラー時の処理継続
```python
class ErrorRecoveryStrategy:
    def handle_file_error(self, file_path: str, error: Exception) -> bool:
        # エラーをログに記録し、処理を継続
        pass
    
    def retry_failed_files(self, failed_files: List[FailedFile]) -> BatchResult:
        # 失敗ファイルの再試行
        pass
```

#### 4.2 部分的成功の処理
- 成功したファイルの結果保存
- 失敗ファイルの詳細記録
- エラーレポートの生成

### 5. リソース管理

#### 5.1 メモリ管理
```python
class MemoryManager:
    def __init__(self, limit_mb: int = 500):
        self.limit_mb = limit_mb
    
    def check_memory_usage(self) -> float:
        # 現在のメモリ使用量を確認
        pass
    
    def should_pause_processing(self) -> bool:
        # メモリ制限に近づいたら一時停止
        pass
```

#### 5.2 CPUリソース管理
- CPU使用率の監視
- 動的なワーカー数調整
- システムリソースへの配慮

## 実装スケジュール

### Week 1（前半）
1. BatchProcessorクラスの基本実装
2. BatchResultデータ構造の定義
3. 基本的なバッチ処理のテスト

### Week 1（後半）
1. マルチプロセシング実装
2. ハイブリッド並列処理の構築
3. 並列処理のベンチマーク

### Week 2（前半）
1. 進捗監視機能の実装
2. エラーハンドリング機構
3. リソース管理機能

### Week 2（後半）
1. 統合テストの実施
2. パフォーマンステスト
3. ドキュメント作成

## テスト計画

### ユニットテスト
- BatchProcessorの各メソッド
- 並列処理の正確性
- エラーハンドリング

### 統合テスト
- 300ファイル処理のベンチマーク
- メモリ使用量の測定
- エラー発生時の動作確認

### ストレステスト
- 1000ファイル以上の処理
- メモリ制限下での動作
- 同時実行時の安定性

## 成功指標
- ✅ 300ファイルを10分以内で処理
- ✅ メモリ使用量500MB以下の維持
- ✅ 並列処理でも100%決定的動作
- ✅ エラー発生時の適切な回復
- ✅ 詳細な進捗情報の提供

## リスクと対策

### リスク1: マルチプロセシングでの決定性確保
**対策**: ファイル処理順序の厳密な管理、結果のソート

### リスク2: メモリ使用量の増大
**対策**: ストリーミング処理の活用、段階的なガベージコレクション

### リスク3: プロセス間通信のオーバーヘッド
**対策**: 適切なバッチサイズの調整、データのシリアライズ最適化

## 実装完了項目（2025-07-03）
1. ✅ batch_processor.pyファイルの作成
2. ✅ BatchProcessorクラスの基本実装
3. ✅ バッチ処理用のデータ型定義（batch_types.py）
4. ✅ 基本的なテストケースの作成（42テスト作成、37テスト成功）

## 実装済みクラス・機能
- **batch_types.py**:
  - FailedFile: 失敗ファイル情報
  - BatchResult: バッチ処理結果
  - ProcessingProgress: 処理進捗情報
  - ProcessingMetrics: 処理メトリクス
  - BatchConfig: バッチ処理設定
- **batch_processor.py**:
  - MemoryManager: メモリ管理（psutil依存、オプショナル）
  - ErrorRecoveryStrategy: エラー回復戦略（最大2回リトライ）
  - BatchProcessor: バッチ処理メインクラス
    - process_files: バッチ処理実行
    - process_files_streaming: ストリーミング処理
    - _process_single_file: 単一ファイル処理（リトライ対応）
    - _process_batch: バッチ処理（並列/逐次切替可）

## 残作業
1. パフォーマンステストの実施
2. 300ファイル処理のベンチマーク
3. APIドキュメントの作成
4. psutil依存の解決（メモリ管理テストの修正）