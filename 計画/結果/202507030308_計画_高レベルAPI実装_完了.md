# 高レベルAPI実装計画 ✅ 完了

## 作成日時
2025-07-03 03:08

## 完了日時
2025-07-03

## 概要
ast2graphライブラリのエンドユーザー向け高レベルAPIを実装する。これにより、シンプルなインターフェースでPythonコードの解析とグラフ変換が可能になる。

## 背景
現在、個別のモジュール（parser, graph_builder, graph_exporter）は実装完了しているが、これらを統合した使いやすいAPIが不足している。ユーザーが簡単にライブラリを利用できるよう、高レベルAPIの実装が必要。

## 実装タスク

### 1. api.pyモジュールの作成
- [x] 高レベルAPI関数の実装
  - [x] parse_file(file_path) - 単一ファイルの解析
  - [x] parse_code(source_code) - 文字列コードの解析
  - [x] parse_directory(directory_path) - ディレクトリ全体の解析
  - [x] parse_files_stream(file_paths) - 大規模ファイルセットのストリーミング処理

### 2. APIの設計方針
- **シンプルなインターフェース**: 1関数呼び出しで完結
- **柔軟な出力形式**: 辞書、JSON、ファイル出力をサポート
- **エラーハンドリング**: 明確なエラーメッセージとリカバリー
- **パフォーマンス**: 大規模プロジェクトに対応

### 3. 各APIの詳細仕様

#### parse_file()
```python
def parse_file(
    file_path: str,
    output_format: str = "dict",
    include_metadata: bool = True,
    include_source_info: bool = True,
    encoding: str = "utf-8"
) -> Union[Dict[str, Any], str, GraphStructure]:
    """
    単一のPythonファイルを解析してグラフに変換する。
    
    Args:
        file_path: 解析対象ファイルのパス
        output_format: 出力形式 ("dict", "json", "graph")
        include_metadata: メタデータを含めるか
        include_source_info: ソース情報を含めるか
        encoding: ファイルエンコーディング
        
    Returns:
        指定された形式でのグラフデータ
    """
```

#### parse_code()
```python
def parse_code(
    source_code: str,
    filename: str = "<string>",
    output_format: str = "dict",
    include_metadata: bool = True
) -> Union[Dict[str, Any], str, GraphStructure]:
    """
    文字列として提供されたPythonコードを解析する。
    
    Args:
        source_code: 解析対象のPythonコード
        filename: 仮想ファイル名（エラー表示用）
        output_format: 出力形式
        include_metadata: メタデータを含めるか
        
    Returns:
        指定された形式でのグラフデータ
    """
```

#### parse_directory()
```python
def parse_directory(
    directory_path: str,
    pattern: str = "**/*.py",
    output_dir: Optional[str] = None,
    parallel: bool = True,
    max_workers: Optional[int] = None,
    progress_callback: Optional[Callable] = None
) -> Dict[str, Union[GraphStructure, Dict[str, Any]]]:
    """
    ディレクトリ内のすべてのPythonファイルを解析する。
    
    Args:
        directory_path: 解析対象ディレクトリ
        pattern: ファイルパターン（glob形式）
        output_dir: 結果の出力先ディレクトリ
        parallel: 並列処理を使用するか
        max_workers: 最大ワーカー数
        progress_callback: 進捗通知用コールバック
        
    Returns:
        ファイルパスをキーとする解析結果の辞書
    """
```

### 4. エラーハンドリング
- [x] ファイルアクセスエラーの処理
- [x] 構文エラーの処理と報告
- [x] メモリ不足時の処理
- [x] 部分的な成功の報告（バッチ処理時）

### 5. パフォーマンス最適化
- [ ] ファイルキャッシュの実装（将来の拡張）
- [x] 並列処理の最適化
- [x] メモリ効率的なストリーミング処理

### 6. テストとドキュメント
- [x] 各API関数の単体テスト
- [ ] 統合テスト（実際のプロジェクトでの動作確認）
- [ ] APIドキュメントの作成
- [ ] 使用例の作成

## 期待される成果
- ユーザーフレンドリーなAPI
- 3行以内でPythonコードの解析が可能
- 大規模プロジェクト（300ファイル以上）の効率的な処理
- 明確なエラーメッセージとリカバリー機能

## 実装優先順位
1. parse_file() - 最も基本的な機能
2. parse_code() - インタラクティブな使用に便利
3. parse_directory() - バッチ処理の要
4. parse_files_stream() - 大規模プロジェクト対応

## 実装結果
1. ✅ api.pyの基本構造を実装完了
2. ✅ parse_file(), parse_code(), parse_directory(), parse_files_stream()すべて実装完了
3. ✅ 各関数の単体テスト作成完了（26個のテストすべて成功）
4. ⏳ ドキュメントとサンプルコードの作成（次のタスク）

## 技術的な決定事項
- ASTParser, GraphBuilder, GraphExporterの既存インターフェースを活用
- エラーハンドリングは適切な例外を再スローする形で実装
- 並列処理はconcurrent.futuresのThreadPoolExecutorを使用
- メタデータとソース情報の除外オプションを実装