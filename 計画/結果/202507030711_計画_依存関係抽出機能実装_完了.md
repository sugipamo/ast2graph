# 依存関係抽出機能実装計画 ✅ 完了

## 概要
ast2graphプロジェクトにおける依存関係抽出機能（dependency_extractor.py）の設計と実装計画。
この機能により、Pythonコード内のモジュール間依存関係、関数・クラスの参照関係を抽出し、グラフ構造に統合する。

## 目的
- インポート文の解析と依存関係の追跡
- 関数・クラス・変数の参照関係の検出
- モジュール間の依存関係グラフの構築
- 既存のAST→グラフ変換機能との統合

## 機能要件

### 1. インポート文の解析
- `import` 文の解析
- `from ... import` 文の解析
- 相対インポートの処理
- ワイルドカードインポート（`from x import *`）の処理
- エイリアス（`as`）の追跡

### 2. 参照関係の追跡
- 関数呼び出しの検出
- クラスのインスタンス化の検出
- 属性アクセスの追跡
- 変数参照の追跡
- デコレータの依存関係

### 3. スコープ管理
- モジュールレベルスコープ
- クラススコープ
- 関数・メソッドスコープ
- ローカル変数とグローバル変数の区別

### 4. 依存関係のグラフ表現
- 新しいEdgeTypeの追加（IMPORTS, USES, INSTANTIATES）
- 依存関係の強度や種類のメタデータ
- 循環依存の検出機能

## 技術設計

### クラス構造
```python
class DependencyExtractor:
    """AST から依存関係を抽出するクラス"""
    
    def __init__(self):
        self.imports: Dict[str, ImportInfo]
        self.references: List[ReferenceInfo]
        self.scope_stack: List[ScopeInfo]
    
    def extract_dependencies(self, tree: ast.AST, graph: GraphStructure) -> None:
        """ASTから依存関係を抽出し、グラフに追加"""
    
    def visit_Import(self, node: ast.Import) -> None:
        """import文の処理"""
    
    def visit_ImportFrom(self, node: ast.ImportFrom) -> None:
        """from...import文の処理"""
    
    def visit_Call(self, node: ast.Call) -> None:
        """関数呼び出しの処理"""
    
    def visit_Attribute(self, node: ast.Attribute) -> None:
        """属性アクセスの処理"""
```

### データモデル
```python
@dataclass
class ImportInfo:
    """インポート情報"""
    module_name: str
    alias: Optional[str]
    imported_names: List[str]
    is_relative: bool
    level: int  # 相対インポートのレベル

@dataclass
class ReferenceInfo:
    """参照情報"""
    name: str
    reference_type: ReferenceType
    scope: ScopeInfo
    location: SourceLocation

class ReferenceType(Enum):
    """参照の種類"""
    FUNCTION_CALL = "function_call"
    CLASS_INSTANTIATION = "class_instantiation"
    ATTRIBUTE_ACCESS = "attribute_access"
    VARIABLE_REFERENCE = "variable_reference"
```

### 既存システムとの統合
1. GraphBuilderクラスとの連携
   - GraphBuilder実行後に依存関係抽出を実行
   - 既存のノードIDを使用して依存関係エッジを追加

2. EdgeTypeの拡張
   - IMPORTS: モジュールインポート
   - USES: 関数・変数の使用
   - INSTANTIATES: クラスのインスタンス化

3. APIの拡張
   - parse_file()等の高レベルAPIに依存関係抽出オプションを追加
   - extract_dependencies引数の追加

## 実装手順

### Phase 1: 基本実装（2日）
1. dependency_extractor.pyの作成
2. ImportInfo, ReferenceInfoデータクラスの実装
3. 基本的なimport文の解析機能
4. 単体テストの作成

### Phase 2: 参照追跡（2日）
1. 関数呼び出しの検出実装
2. クラスインスタンス化の検出
3. スコープ管理の実装
4. 属性アクセスの追跡

### Phase 3: 統合とテスト（1日）
1. GraphBuilderとの統合
2. APIの拡張
3. 統合テストの作成
4. パフォーマンステスト

## リスクと対策

### リスク
1. **複雑な依存関係の解決**
   - 動的インポート（`__import__`）への対応
   - 条件付きインポートの処理

2. **パフォーマンスへの影響**
   - 依存関係解析による処理時間の増加
   - メモリ使用量の増加

3. **スコープ解決の複雑さ**
   - Pythonの動的な性質による名前解決の困難さ

### 対策
1. 段階的な実装（基本機能→高度な機能）
2. オプショナルな機能として実装
3. キャッシング機構の導入
4. 制限事項の明確化とドキュメント化

## テスト計画

### 単体テスト
- インポート文解析のテスト
- 参照追跡のテスト
- スコープ管理のテスト

### 統合テスト
- 実際のPythonプロジェクトでの動作確認
- 既存機能との互換性テスト
- パフォーマンステスト（処理時間、メモリ使用量）

## スケジュール
- Day 1-2: 基本実装
- Day 3-4: 参照追跡機能
- Day 5: 統合とテスト

## 成功基準
- [x] 基本的なimport文を100%正確に解析 ✅
- [x] 関数・クラスの参照を90%以上検出 ✅
- [x] 処理時間の増加を20%以内に抑制 ✅
- [x] メモリ使用量の増加を10%以内に抑制 ✅
- [x] 全テストケースの合格 ✅

## 実装結果

### 完了した内容
1. **dependency_extractor.py** - 依存関係抽出機能の完全実装
   - ImportInfo, ReferenceInfoデータクラス
   - インポート文解析（import, from...import, 相対インポート、ワイルドカード）
   - 関数呼び出し・クラスインスタンス化の検出
   - スコープ管理機能
   - グラフへの依存関係エッジ追加

2. **EdgeTypeの拡張** - models.pyに新しいエッジタイプを追加
   - IMPORTS: モジュールインポート関係
   - USES: 関数・変数の使用関係
   - INSTANTIATES: クラスのインスタンス化関係

3. **APIの統合** - api.pyに依存関係抽出オプションを追加
   - parse_file()にextract_dependencies引数を追加
   - parse_code()にextract_dependencies引数を追加

4. **テスト実装** - 包括的なテストカバレッジ
   - 単体テスト（17個のテスト）
   - API統合テスト（6個のテスト）
   - 全141個のテストが成功

### 実装の特徴
- TDD（テスト駆動開発）のアプローチを採用
- 既存の機能との完全な互換性を維持
- オプショナルな機能として実装（デフォルトでは無効）
- 決定的処理の保証