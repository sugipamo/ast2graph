# テスト失敗修正実装計画

## 概要
現在34個のテストが失敗している状況を修正し、全テストをパスさせる。

## 現状分析
### 失敗しているテストの分類
1. **APIパラメータ関連**（最多）
   - `include_dependencies`パラメータが未実装
   - api.pyの各関数でこのパラメータを受け取るが機能していない

2. **エンコーディング処理関連**
   - UTF-8 BOM付きファイルの処理失敗
   - Latin-1エンコーディングの対応不足
   - 無効なエンコーディングのエラーハンドリング

3. **ストリーミング処理関連**
   - parse_files_stream()の実装が不完全
   - メモリ効率的な処理が未実装

4. **決定性保証関連**
   - ノードID生成の一貫性問題
   - ファイル処理順序による結果の変動

## 実装計画

### 1. include_dependenciesパラメータの実装（優先度: 最高）
**影響範囲**: api.py, graph_builder.py, dependency_extractor.py

**実装内容**:
1. api.pyの各関数にinclude_dependenciesパラメータを追加
   - parse_file()
   - parse_code()
   - parse_directory()
   - parse_files_stream()

2. パラメータがTrueの場合、dependency_extractor.pyを使用して依存関係を抽出

3. グラフ構築時に依存関係エッジを追加

**推定作業時間**: 2時間

### 2. エンコーディング処理の改善（優先度: 高）
**影響範囲**: parser.py

**実装内容**:
1. UTF-8 BOMの検出と除去処理
   ```python
   if content.startswith('\ufeff'):
       content = content[1:]
   ```

2. エンコーディング検出の改善
   - chardetを使わずPure Python実装
   - Latin-1フォールバック処理
   - エラー時の適切な例外発生

3. 無効なエンコーディングに対するエラーハンドリング

**推定作業時間**: 1.5時間

### 3. ストリーミング処理の完全実装（優先度: 中）
**影響範囲**: api.py

**実装内容**:
1. parse_files_stream()の改善
   - ジェネレータとして正しく動作
   - メモリ効率的な実装
   - チャンクサイズの最適化

2. エラーハンドリングの改善
   - 個別ファイルのエラーを適切に処理
   - エラー時もストリーミングを継続

**推定作業時間**: 1時間

### 4. 決定性保証の強化（優先度: 中）
**影響範囲**: graph_builder.py, api.py

**実装内容**:
1. ノードID生成の改善
   - ファイルパスの正規化
   - 一貫したハッシュ生成

2. ファイル処理順序の統一
   - parse_directory()でのソート処理
   - 並列処理時の結果統合方法

**推定作業時間**: 1時間

## テスト戦略
1. 各修正後に関連するユニットテストを実行
2. 全修正完了後に統合テストを実行
3. テストカバレッジの確認

## 成功基準
- 全170個のテスト（ユニット141個 + 統合29個）がパス
- テストカバレッジ90%以上
- パフォーマンステストもパス（10分以内、メモリ500MB以下）

## リスクと対策
- **リスク**: 修正により既存の動作が壊れる可能性
- **対策**: 各修正を小さくコミットし、問題があれば即座にロールバック

## 総推定作業時間
5.5時間

## 実装順序
1. include_dependenciesパラメータの実装（最も多くのテストに影響）
2. エンコーディング処理の改善
3. 決定性保証の強化
4. ストリーミング処理の完全実装