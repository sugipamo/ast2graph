# ast2graph テスト失敗の修正計画

## 作成日時
2025年7月3日 08:13

## 概要
pytestの実行結果から34個のテスト失敗が確認されました。主に以下の問題が原因です。

## 問題の分類と優先度

### 1. 高優先度: API引数の不一致 (10件)
**問題**: `include_dependencies`パラメータがAPIに未実装
**該当箇所**:
- `parse_file()`, `parse_directory()`, `parse_code()` 関数
- tests/integration/test_real_projects.py

**修正方針**:
- api.py に `include_dependencies` パラメータを追加
- デフォルト値は `False` に設定
- 依存関係抽出のオプショナル機能として実装

### 2. 中優先度: エンコーディング処理 (5件)
**問題**: UTF-8 BOM、Latin-1、無効なエンコーディングの処理が不完全
**該当箇所**:
- tests/integration/test_error_scenarios.py

**修正方針**:
- parser.py でエンコーディング検出ロジックを強化
- `chardet` ライブラリの使用を検討（外部依存なしの要件と相談）
- エラーハンドリングの改善

### 3. 中優先度: ストリーミング処理 (8件)
**問題**: ストリーミングAPIの実装が不完全
**該当箇所**:
- `parse_files_stream()` 関数の実装
- メモリ効率性のテスト

**修正方針**:
- ジェネレータベースの実装を確認・修正
- チャンクサイズの適切な設定
- メモリ使用量の最適化

### 4. 低優先度: 決定性の保証 (6件)
**問題**: ノードIDの一貫性、ファイル順序の独立性
**該当箇所**:
- graph_builder.py のノードID生成ロジック

**修正方針**:
- ノードID生成を決定的なハッシュベースに変更
- ファイル処理順序の正規化

### 5. その他のエラー (5件)
- 空ファイルの処理
- Unicode識別子のサポート
- 循環参照の検出

## 実装順序

1. **Phase 1**: API引数の修正（最重要）
   - api.py の修正
   - 関連テストの更新

2. **Phase 2**: エンコーディング処理の改善
   - parser.py の強化
   - エラーハンドリングの実装

3. **Phase 3**: ストリーミング処理の完成
   - メモリ効率的な実装
   - チャンク処理の最適化

4. **Phase 4**: 決定性の保証
   - ID生成ロジックの改善
   - 順序独立性の実装

## テスト実行コマンド
```bash
export PYTHONPATH=/home/coding/code-smith/ast2graph/src:$PYTHONPATH
python3 -m pytest -v -x  # 最初のエラーで停止
python3 -m pytest -v tests/unit/  # ユニットテストのみ
python3 -m pytest -v tests/integration/  # 統合テストのみ
```

## 注意事項
- 外部依存なし（Pure Python）の要件を維持
- 後方互換性を保つ
- エラーメッセージを明確に

## 次のアクション
1. api.py に `include_dependencies` パラメータを追加
2. 失敗しているテストを個別に確認・修正
3. 全テストがパスすることを確認