# コード品質改善提案

作成日時: 2025-07-03 13:47
ステータス: 計画中

## 概要

ast2graphプロジェクトのコード品質分析の結果、全体的に良好な実装がされていますが、いくつかの改善点が見つかりました。本計画書では、コード品質をさらに向上させるための具体的な改善提案をまとめます。

## 現状分析結果

### テスト実行結果
- **pytest実行**: 238件のテストすべてが成功（成功率100%）
- **警告**: psutilモジュール未インストールによる警告（9件）
- **パフォーマンス**: 3.70秒で全テスト完了

### コード品質評価
- **総合評価**: B+ (良好だが改善の余地あり)
- **強み**: 型アノテーション、エラーハンドリング、テストカバレッジ
- **弱み**: ドキュメント言語の混在、一部の複雑な関数、パフォーマンス最適化の余地

## 優先度別改善提案

### 優先度: 高

#### 1. ドキュメントの言語統一
**問題点**: 日本語と英語のdocstringが混在
**影響ファイル**: 
- `api.py`
- `graph_exporter.py`

**改善方法**:
```python
# 現在（日本語）
"""
AST解析とグラフ構造変換の高レベルAPI

このモジュールは、ast2graphライブラリの主要な機能へのシンプルなインターフェースを提供します。
"""

# 改善後（英語）
"""
High-level API for AST parsing and graph structure conversion.

This module provides a simple interface to the main functionality of the ast2graph library.
"""
```

#### 2. 複雑な関数のリファクタリング

**対象関数**:
1. `dependency_extractor.py`: `_add_reference_edges`メソッド（87行）
2. `api.py`: `parse_directory`関数（97行）
3. `graph_builder.py`: `_determine_edge_type`メソッド（53行）

**改善アプローチ**:
- 責務の分割
- ヘルパー関数の抽出
- 早期リターンの活用

### 優先度: 中

#### 3. セキュリティ強化

**実装内容**:
1. **パストラバーサル対策**
```python
import os

def validate_path(base_path: str, target_path: str) -> bool:
    """Validate that target_path is within base_path."""
    base = os.path.abspath(base_path)
    target = os.path.abspath(target_path)
    return target.startswith(base)
```

2. **リソース制限**
```python
MAX_AST_NODES = 1_000_000
MAX_PROCESSING_TIME = 300  # seconds

def check_resource_limits(node_count: int, start_time: float) -> None:
    if node_count > MAX_AST_NODES:
        raise ResourceLimitExceeded(f"AST node count {node_count} exceeds limit {MAX_AST_NODES}")
    
    elapsed = time.time() - start_time
    if elapsed > MAX_PROCESSING_TIME:
        raise ResourceLimitExceeded(f"Processing time {elapsed}s exceeds limit {MAX_PROCESSING_TIME}s")
```

#### 4. 型アノテーションの改善

**現状**: `Dict[str, Any]`の多用
**改善**: TypedDictまたはデータクラスの使用

```python
from typing import TypedDict

class GraphMetadata(TypedDict):
    version: str
    created_at: str
    source_count: int
    node_count: int
    edge_count: int
```

### 優先度: 低

#### 5. パフォーマンス最適化

1. **メモリ効率の改善**
   - 双方向エッジインデックスの見直し
   - ジェネレータの活用

2. **大規模ファイル対応**
   - ストリーミング処理の強化
   - 部分的なAST解析の実装

#### 6. psutilの追加

```bash
# pyproject.tomlに追加
[project.optional-dependencies]
performance = ["psutil>=5.9.0"]
```

## 実装計画

### フェーズ1（1-2日）
- [ ] ドキュメントの言語統一
- [ ] psutil依存関係の追加

### フェーズ2（3-5日）
- [ ] 複雑な関数のリファクタリング
- [ ] 単体テストの追加

### フェーズ3（1週間）
- [ ] セキュリティ強化の実装
- [ ] 型アノテーションの改善

### フェーズ4（2週間以降）
- [ ] パフォーマンス最適化
- [ ] ベンチマークテストの追加

## 成功指標

1. **コード品質**
   - すべてのdocstringが英語で統一
   - 関数の循環的複雑度が10以下
   - 型チェッカー（mypy）でエラーなし

2. **パフォーマンス**
   - 300ファイル処理で5分以内（現在の半分）
   - メモリ使用量300MB以下（現在の60%）

3. **セキュリティ**
   - パストラバーサル攻撃への完全な対策
   - リソース枯渇攻撃への防御

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| リファクタリングによる既存機能の破壊 | 高 | 包括的なテストスイートの維持 |
| パフォーマンス最適化による可読性低下 | 中 | コードレビューの徹底 |
| 後方互換性の喪失 | 高 | セマンティックバージョニングの遵守 |

## まとめ

ast2graphプロジェクトは既に高品質なコードベースを持っていますが、上記の改善を実施することで、より堅牢で保守性の高いライブラリになります。特に、ドキュメントの統一と複雑な関数のリファクタリングは、今後の開発効率に大きく貢献すると考えられます。